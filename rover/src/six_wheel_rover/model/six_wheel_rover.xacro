<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- 1. MACRO DEFINITION -->
  <!-- We define this as a macro so it can be called by other files -->
  <xacro:macro name="six_wheel_rover">
    
    <!-- 2. BASE FOOTPRINT (Dummy Root) -->
    <!-- Fixes the KDL warning about root link having inertia -->
    <link name="base_footprint"/>

    <joint name="base_joint" type="fixed">
      <parent link="base_footprint"/>
      <child link="base_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>

    <!-- === Base (Chassis) === -->
    <link name="base_link">
      <inertial>
        <origin xyz="0 0 0.15" rpy="0 0 0"/> 
        <mass value="10.0"/>
        <inertia ixx="0.5" ixy="0.0" iyy="0.5" iyz="0.0" izz="0.01" ixz="0.0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0.15" rpy="0 0 0"/>
        <geometry>
          <box size="1.0 0.5 0.2"/>
        </geometry>
        <material name="gray">
          <color rgba="0.7 0.7 0.7 1"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0.15" rpy="0 0 0"/>
        <geometry>
          <box size="1.0 0.45 0.2"/>
        </geometry>
      </collision>
    </link>

    <!-- === Wheels === -->
    <!-- LEFT WHEELS -->
    <link name="left_front_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
        <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <link name="left_middle_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <link name="left_rear_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <!-- RIGHT WHEELS -->
    <link name="right_front_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <link name="right_middle_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <link name="right_rear_wheel">
      <inertial>
        <mass value="1.0"/>
        <inertia ixx="0.01" ixy="0.0" iyy="0.01" iyz="0.0" izz="0.01" ixz="0.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="1.5708 0 0"/>
        <geometry><cylinder radius="0.1" length="0.05"/></geometry>
      </collision>
    </link>

    <!-- === Joints === -->
    <joint name="left_front_joint" type="continuous">
      <parent link="base_link"/>
      <child link="left_front_wheel"/>
      <origin xyz="-0.4 0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <joint name="left_middle_joint" type="continuous">
      <parent link="base_link"/>
      <child link="left_middle_wheel"/>
      <origin xyz="0.0 0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <joint name="left_rear_joint" type="continuous">
      <parent link="base_link"/>
      <child link="left_rear_wheel"/>
      <origin xyz="0.4 0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <joint name="right_front_joint" type="continuous">
      <parent link="base_link"/>
      <child link="right_front_wheel"/>
      <origin xyz="-0.4 -0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <joint name="right_middle_joint" type="continuous">
      <parent link="base_link"/>
      <child link="right_middle_wheel"/>
      <origin xyz="0.0 -0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <joint name="right_rear_joint" type="continuous">
      <parent link="base_link"/>
      <child link="right_rear_wheel"/>
      <origin xyz="0.4 -0.275 0.1" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
    </joint>

    <!-- === ROS2 Control === -->
    <ros2_control name="SixWheelSystem" type="system">
      <hardware>
        <plugin>gz_ros2_control/GazeboSimSystem</plugin>
      </hardware>
      <joint name="left_front_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="left_middle_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="left_rear_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="right_front_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="right_middle_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
      <joint name="right_rear_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </ros2_control>

    <gazebo>
      <plugin name="gz_ros2_control::GazeboSimROS2ControlPlugin" filename="libgz_ros2_control-system.so">
        <parameters>$(find six_wheel_rover)/config/six_wheel_rover_controller.yaml</parameters>
      </plugin>
      <plugin
        filename="libgz-sim-pose-publisher-system.so"
        name="gz::sim::systems::PosePublisher">
        <publish_link_pose>false</publish_link_pose>
        <use_pose_vector_msg>true</use_pose_vector_msg>
        <publish_nested_model_pose>true</publish_nested_model_pose>
        <update_frequency>100</update_frequency>
      </plugin>
    </gazebo>
    
    <gazebo>
      <plugin
        filename="gz-sim-odometry-publisher-system"
        name="gz::sim::systems::OdometryPublisher">
        <odom_frame>odom</odom_frame>
        <robot_base_frame>base_footprint</robot_base_frame>
        <dimensions>3</dimensions>
        <odom_topic>/odom</odom_topic> 
        <tf_topic>/tf</tf_topic>
        <odom_publish_frequency>100</odom_publish_frequency>
      </plugin>
    </gazebo>
  </xacro:macro>

</robot>
